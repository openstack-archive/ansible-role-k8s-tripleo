- name: Create glance keystone job
  k8s_v1_job:
    host: "{{coe_host}}"
    context: "{{kube_context}}"
    kubeconfig: "{{config_file}}"
    name: '{{service_name}}-keystone'
    namespace: "{{namespace}}"
    state: present
    restart_policy: OnFailure
    containers:
      - image: tripleoupstream/centos-binary-glance-api
        name: '{{service_name}}-keystone-user'
        command:
          - openstack
          - user
          - create
          - --project
          - '{{service_project}}'
          - --password
          - '{{service_password}}'
          - '{{service_username}}'
        env:
          - name: OS_IDENTITY_API_VERSION
            value: "3"
          - name: OS_AUTH_URL
            value: '{{auth_url}}'
          - name: OS_DEFAULT_DOMAIN
            value: '{{domain_name}}'
          - name: OS_USERNAME
            value: '{{username}}'
          - name: OS_PASSWORD
            value: '{{password}}'
          - name: OS_PROJECT_NAME
            value: '{{project_name}}'
      - image: tripleoupstream/centos-binary-glance-api
        name: '{{service_name}}-keystone-service'
        command:
          - openstack
          - service
          - create
          - --enable
          - --name
          - '{{service_name}}'
          - '{{service_type}}'
        env:
          - name: OS_IDENTITY_API_VERSION
            value: "3"
          - name: OS_AUTH_URL
            value: '{{auth_url}}'
          - name: OS_DEFAULT_DOMAIN
            value: '{{domain_name}}'
          - name: OS_USERNAME
            value: '{{username}}'
          - name: OS_PASSWORD
            value: '{{password}}'
          - name: OS_PROJECT_NAME
            value: '{{project_name}}'
      - image: tripleoupstream/centos-binary-glance-api
        name: '{{service_name}}-keystone-internal-url'
        command:
          - openstack
          - endpoint
          - create
          - --region
          - '{{service_region}}'
          - --enable
          - '{{service_name}}'
          - 'internal'
          - '{{service_internal_url}}'
        env:
          - name: OS_IDENTITY_API_VERSION
            value: "3"
          - name: OS_AUTH_URL
            value: '{{auth_url}}'
          - name: OS_DEFAULT_DOMAIN
            value: '{{domain_name}}'
          - name: OS_USERNAME
            value: '{{username}}'
          - name: OS_PASSWORD
            value: '{{password}}'
          - name: OS_PROJECT_NAME
            value: '{{project_name}}'
      - image: tripleoupstream/centos-binary-glance-api
        name: '{{service_name}}-keystone-public-url'
        command:
          - openstack
          - endpoint
          - create
          - --region
          - '{{service_region}}'
          - --enable
          - '{{service_name}}'
          - 'public'
          - '{{service_public_url}}'
        env:
          - name: OS_IDENTITY_API_VERSION
            value: "3"
          - name: OS_AUTH_URL
            value: '{{auth_url}}'
          - name: OS_DEFAULT_DOMAIN
            value: '{{domain_name}}'
          - name: OS_USERNAME
            value: '{{username}}'
          - name: OS_PASSWORD
            value: '{{password}}'
          - name: OS_PROJECT_NAME
            value: '{{project_name}}'
      - image: tripleoupstream/centos-binary-glance-api
        name: '{{service_name}}-keystone-admin-url'
        command:
          - openstack
          - endpoint
          - create
          - --region
          - '{{service_region}}'
          - --enable
          - '{{service_name}}'
          - 'admin'
          - '{{service_admin_url}}'
        env:
          - name: OS_IDENTITY_API_VERSION
            value: "3"
          - name: OS_AUTH_URL
            value: '{{auth_url}}'
          - name: OS_DEFAULT_DOMAIN
            value: '{{domain_name}}'
          - name: OS_USERNAME
            value: '{{username}}'
          - name: OS_PASSWORD
            value: '{{password}}'
          - name: OS_PROJECT_NAME
            value: '{{project_name}}'
        volume_mounts:
        - name: kolla-config
          mountPath: /var/lib/kolla/config_files/
    volumes:
      - name: kolla-config
        config_map:
          name: glance
    state: present
